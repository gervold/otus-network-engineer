# IPv4/6

#### Цель:
В данной самостоятельной работе необходимо распланировать адресное пространство.<br>
Настроить IP на всех активных портах для дальнейшей работы над проектом.<br>
Адресное пространство должно быть задокументировано.<br>

#### Описание/Пошаговая инструкция выполнения домашнего задания:

В этой самостоятельной работе мы ожидаем, что вы самостоятельно:

1) Разработаете и задокументируете адресное пространство для лабораторного стенда.
2) Настроите IP адреса на каждом активном порту.
3) Настроите каждый VPC в каждом офисе в своем VLAN.
4) Настроите VLAN управления для сетевых устройств.
5) Настроите сети офисов так, чтобы не возникало broadcast штормов, а использование линков было максимально оптимизировано.

## Поехали!


### Распределение VLAN

Для внутреннего использования рекомендуется использовать номера VLAN > 1006.
Об этом говорит запись в конфиге:
```
vlan internal allocation policy ascending
```
В случае использования номера меньше – запись не занесется в `running-config`,
но будет храниться в специфичном файле `vlan.dat-XXXXX`.

Note: можно использовать и descending policy, тогда используемые номера нужно будет отсчитывать вниз от 4096.  
```
Layer-3 Catalysts use VLAN id's internally for a few things, one of these is routed interfaces (no switchport). 
By default the internal allocation policy is ascending - that means it will use VLAN 1006 and upwards for internal usage. 
If you change this to descending it starts at 4094 and goes down.
```
[источник](https://community.cisco.com/t5/network-management/vlan-internal-allocation-policy-ascending-descending/td-p/530198#:~:text=By%20default%20the%20internal%20allocation,at%204094%20and%20goes%20down.)

Для ~~усложнения~~ упрощения конфигурирования (на маленьких сетях) – отключим VTP (VLAN Trunking Protocol):

```
SW3#configure terminal
SW3(config)#vtp mode transparent
Setting device to VTP Transparent mode for VLANS.
SW3(config)#end
```

После этого в `running-config` начнут отображаться все настроенные VLAN:
```
SW3#show running-config
***
!
vlan 1000
 name Management
!
```
Note: VTP создан для упрощения конфигурирования сетей с большим количеством устройств и VLAN-ов.  
VLAN-ы автоматически передаются через коммутаторы (в соответствии с VTP ролью и доменом).  
Отсюда возникает проблема с безопасностью – если принести новый коммутатор, с кривыми VLAN-ми, то они могут "пролиться" на другие коммутаторы, организовав мусорку. 

### IP планирование

### IPv4 

Принципы выделения IPv4-адресов:
- для организации внутренней связности выдаем адреса из приватной сети `10.0.0.0/8`
- Management адреса коммутаторов из `172.16.0.0/12`
- последний октет адреса совпадает с номером устройства на схеме.  
предпоследний октет, по возможности, выбирается из номеров интерфейсов устройств линка.  Например для линка `R12 e0/2-e0/0 R14` будем выбирать номер предпоследнего октета из {0, 2}.  
Условие выбора - отсутствие конфликтов с другими IP.
- белые адреса выбираются похожими на номер AS, в которой они используются.
Например, провайдеры из Триады (AS `520`) выдают клиентам сети с первым октетом `52` (`52.0.0.24`).
- подсеть `192.168.0.0/16` буду использовать по мере необходимости далее, в том числе для ~~костыльных~~ специфичных соединений. 


### IPv6

Для **IPv6** возьмем `2022:0:0:0::/48` и будем выдавать адреса из нее, на основе IPv4 адресов,
по следующему правилу (описано на python):

```python
def convert_4_to_6(ipv4_address):
    a,b,c,d = ipv4_address.split('.')
    return "2022::"+":".join([a,b,c,d])

# Пример:
convert_4_to_6('10.0.3.12')
'2022::10:0:3:12'
```

**Link-local** адреса будем выделять из `FE80::/10` по номеру устройства.  
Например:
- для R22 адрес будет `FE80::22`
- для SW4 адрес будет `FE80::4`

#### Полезные ссылки:

- [RFC1918. Про выделение IPv4-адресов для приватных сетей](https://datatracker.ietf.org/doc/html/rfc1918)
- [3021. Using 31-bit prefixes on IPv4 PTP Links](https://datatracker.ietf.org/doc/html/rfc3021). Сокращение кол-ва используемых IP.
- [Вдохновение можно поискать в СДСМ](https://linkmeup.ru/blog/1188/). Примеры L1, L2, L3 документации.

<details> 

<summary>Про именование устройств</summary>

В данной работе имена устройств уже выданы и зафиксированы, но существуют некоторые соглашения именования устройств (`hostname`).

Примерно такие:
- Сокращённое название города (msk) + географическое расположение (улица, здание) (arbat) + роль устройства в сети + порядковый номер.
 
Тоесть выбираем hostname соответственно роли и месту расположения устройства (потом удобно читать `traceroute`). 

Например:
- Маршрутизатор 2811: `msk-arbat-gw1` (**gw**=**GateWay**=шлюз)
- Коммутатор 2960: `msk-arbat-dsw1` (**dsw**=**Distribution switch**)
- Коммутаторы 2950: `msk-arbat-aswN`, `msk-rubl-asw1` (**asw**=**Access switch**)


[все тот же СДСМ](https://linkmeup.ru/blog/1188/)

</details>

### ASN карта

|Location|ASN|
|--------|---|
|Москва|1001|
|Питер|2042|
|Ламас|301|
|Киторн|101|
|Триада|520|
|Чокурдах|-|
|Лабынтаги|-|


### IP карта устройств

### Москва (AS1001)

Москва – 3-х уровневая модель:
- Core layer – R14, R15  
- Distribution layer – SW4, SW5, R12?, R13?  
- Access layer – SW2, SW3, VPC1, VPC7  

Так как имеется много коммутаторов, ~~а мы ленивые и небогатые~~, то для организации проще использовать _STP based_ схему организации 
access layer.

| Device | Port | IPv4 | IPv6 | VLAN | Link | Comment |
|---|---|---|---|---|---|---|
| VPC1 | eth0 | 100.0.0.1 | 2022::100:0:0:1 | - | VPC1 eth0–e0/2 SW3 | |
| VPC7 | eth0 | 100.0.1.7 | 2022::100:0:1:7 | - | VPC7 eth0–e0/2 SW2 | |
| SW2 |  | 172.16.0.2 | 2022::172:16:0:2 | 1100 |  | Management |
|  | e0/2 |  |  | 70 | SW2 e0/2-eth0 VPC7 | End Users |
| SW3 |  | 172.16.0.3 | 2022::172:16:0:3 | 1100 |  | Management |
|  | e0/2 |  |  | 10 | SW3 e0/2-eth0 VPC1 | End Users |
| SW4 |  | 172.16.0.4 | 2022::172:16:0:4 | 1100 |  | Management |
| SW5 |  | 172.16.0.5 | 2022::172:16:0:5 | 1100 |  | Management |
| R12 | e0/0 |  |  | - | R12 e0/0-e1/0 SW4 | Connectivity |
|  | e0/1 |  |  | - | R12 e0/1-e1/1 SW5 | Robustness |
|  | e0/2 | 10.0.2.12 |  | - | R12 e0/2-e0/0 R14 | Connectivity |
|  | e0/3 | 10.0.1.12 |  | - | R12 e0/3-e0/1 R15 | Robustness |
| R13 | e0/0 |  |  | - | R13 e0/0-e1/0 SW5 | Connectivity |
|  | e0/1 |  |  | - | R13 e0/1-e1/1 SW4 | Robustness |
|  | e0/2 | 10.0.2.13 |  | - | R13 e0/2-e0/0 R15 | Connectivity |
|  | e0/3 | 10.0.1.13 |  | - | R13 e0/3-e0/1 R14 | Robustness |
| R14 | e0/0 | 10.0.2.14 |  | - | R14 e0/0-e0/2 R12 | Connectivity |
|  | e0/1 | 10.0.1.14 |  | - | R14 e0/1-e0/3 R13 | Robustness |
|  | e0/2 | **101.0.0.14** |  | - | R14 e0/2-e0/0 R22 | BGP, Provider link |
|  | e0/3 | 10.0.3.14 |  | - | R14 e0/3-e0/0 R19 | Default (OSPF) |
| R15 | e0/0 | 10.0.2.15 |  | - | R15 e0/0-e0/2 R13 | Connectivity |
|  | e0/1 | 10.0.1.15 |  | - | R15 e0/1-e0/3 R12 | Robustness |
|  | e0/2 | **30.0.0.15** |  | - | R15 e0/2-e0/0 R21 | BGP, Provider link |
|  | e0/3 | 10.0.3.15 |  | - | R15 e0/3-e0/0 R20 | Default (OSPF) |
| R19 | e0/0 | 10.0.3.19 |  | - | R19 e0/0-e0/3 R14 | Default (OSPF) |
| R20 | e0/0 | 10.0.3.20 |  | - | R20 e0/0-e0/3 R15 | Default (OSPF) |


### Питер

Питерский офис меньше (т.е. не нужно настраивать много сетей), поэтому 
для организации уровня доступа будем использовать _L3 access layer_ схему 
~~(а потом сделаем из него ЦОД)~~.

| Device | Port | IPv4 | IPv6 | VLAN | Link | Comment |
|---|---|---|---|---|---|---|
| VPC | eth0 | 200.0.0.6 |  | 60 | VPC eth0–e0/2 SW10 |  |
| VPC8 | eth0 | 200.0.0.8 |  | 80 | VPC8 eth0–e0/2 SW9 |  |
| SW9 |  | 172.16.0.9 |  | 1100 |  | Management |
|  |  |  |  | 80 | SW9 e0/2-eth0 VPC8 | End Users |
|  |  | 10.0.1.9 |  | - | SW9 e0/3-e0/0 R17 | End Users |
| SW10 |  | 172.0.0.10 |  | 1100 |  | Management |
|  |  | 172.0.0.10 |  | 1100 |  | Management |
|  |  | 10.0.0.10 |  | - | SW10 e0/3-e0/0 R16 | End Users |
| R16 | e0/0 | 10.0.0.16 |  | - | R16 e0/0 – e0/3 SW10 | Connectivity |
|  | e0/1 | 10.0.1.16 |  | - | R16 e0/1 – e0/0 R18 | Connectivity |
|  | e0/2 | 10.0.2.16 |  | - | R16 e0/2 – e1/0 SW9 | Robustness |
|  | e0/3 | 10.0.3.16 |  | - | R16 e0/3 – e0/0 R32 | Default (EIGRP) |
| R17 | e0/0 | 10.0.1.17 |  | - | R17 e0/0 – e0/3 SW9 | Connectivity |
|  | e0/1 | 10.0.0.17 |  | - | R17 e0/1 – e0/1 R18 | Connectivity |
|  | e0/2 | 10.0.2.17 |  | - | R17 e0/2 – e1/0 SW10 | Robustness |
| R18 | e0/0 | 10.0.1.18 |  | - | R18 e0/0 – e0/1 R16 | Connectivity |
|  | e0/1 | 10.0.0.18 |  | - | R18 e0/1 – e0/1 R17 | Connectivity |
|  | e0/2 | **52.0.1.18** |  | - | R18 e0/2 – e0/3 R24 | BGP, Provider link |
|  | e0/3 | **52.0.2.18** |  | - | R18 e0/3 – e0/3 R26 | BGP, Provider link |
| R32 | e0/0 | 10.0.3.32 |  | - | R32 e0/0 – e0/3 R16 | Default (EIGRP) |

### Ламас

Провайдер.

Между Ламас и Киторн – серый пиринговый стык.

Провайдеры выдают "сети присоединения" клиентам.

| Device Name | Port | IPv4 | IPv6 | VLAN | Link | Comment |
|---|---|---|---|---|---|---|
| R21 | e0/0 | **30.0.0.21** |  | - | R21 e0/0 – e0/2 R15 | BGP, Customer link |
|  | e0/1 | 192.168.0.21 |  | - | R21 e0/1 – e0/1 R22 | BGP, Peering link |
|  | e0/2 | **52.0.0.21** |  | - | R21 e0/2 – e0/0 R24 | BGP, Provider link |


### Киторн

Провайдер.

| Device Name | Port | IPv4 | IPv6 | VLAN | Link | Comment |
|---|---|---|---|---|---|---|
| R22 | e0/0 | **101.0.0.22** |  | - | R22 e0/0 – e0/2 R14 | BGP, Customer link |
|  | e0/1 | 192.168.0.22 |  | - | R22 e0/1 – e0/1 R21 | BGP, Peering link |
|  | e0/2 | **52.0.0.22** |  | - | R22 e0/2 – e0/0 R23 | BGP, Provider link |

### Триада

В триаде на loopback'и – можно повесить белую сеть.

| Device Name | Port | IPv4 | IPv6 | VLAN | Link | Comment |
|---|---|---|---|---|---|---|
| R23 | e0/0 | **52.0.0.23** |  | - | R23 e0/0 – e0/2 R22 | BGP, Customer link |
|  | e0/1 | 10.0.1.23 |  | - | R23 e0/1 – e0/0 R25 | Connectivity |
|  | e0/2 | 10.0.0.23 |  | - | R23 e0/2 – e0/2 R24 | Connectivity |
| R24 | e0/0 | **52.0.0.24** |  | - | R24 e0/0 – e0/2 R21 | BGP, Customer link |
|  | e0/1 | 10.0.3.24 |  | - | R24 e0/1 – e0/0 R26 | Connectivity |
|  | e0/2 | 10.0.0.24 |  | - | R24 e0/2 – e0/2 R23 | Connectivity |
|  | e0/3 | **52.0.1.24** |  | - | R24 e0/3 – e0/2 R18 | BGP, Customer link |
| R25 | e0/0 | 10.0.1.25 |  | - | R25 e0/0 – e0/1 R23 | Connectivity |
|  | e0/1 | **52.0.5.25** |  | - | R25 e0/1 – e0/0 R27 | BGP, Customer link |
|  | e0/2 | 10.0.2.25 |  | - | R25 e0/2 – e0/2 R26 | Connectivity |
|  | e0/3 | **52.0.4.25** |  | - | R25 e0/3 – e0/1 R28 | BGP, Customer link |
| R26 | e0/0 | 10.0.3.26 |  | - | R26 e0/0 – e0/1 R24 | Connectivity |
|  | e0/1 | **52.0.3.26** |  | - | R26 e0/1 – e0/0 R28 | BGP, Customer link |
|  | e0/2 | 10.0.2.26 |  | - | R26 e0/2 – e0/2 R25 | Connectivity |
|  | e0/3 | **52.0.2.26** |  | - | R26 e0/3 – e0/3 R18 | BGP, Customer link |


### Лабынтаги
| Device Name | Port | IPv4 | IPv6 | VLAN | Link | Comment |
|---|---|---|---|---|---|---|
| R27 | e0/0 | **52.0.5.27** |  | - | R27 e0/0 – e0/1 R25 | Default |


### Чокурдах

| Device Name | Port | IPv4 | IPv6 | VLAN | Link | Comment |
|---|---|---|---|---|---|---|
| R28 | e0/0 | **52.0.3.28** |  | - | R28 e0/0 – e0/1 R26 | BGP, Provider link |
|  | e0/1 | **52.0.4.28** |  | - | R28 e0/1 – e0/3 R25 | BGP, Provider link |
|  | e0/2 | 30.0.0.1 |  | - | R28 e0/2 – e0/2 SW29 | Default (L2) |
| SW29 |  | 172.16.0.29 |  | 1100 | - | Management |
|  |  |  |  | 300 | - | End Users |
|  |  |  |  | 310 | - | End Users |
| VPC30 | eth0 | 30.0.0.30 |  | 300 |  | |
| VPC31 | eth0 | 30.0.0.31 |  | 310 |  | |


### Заметка про принципы построения access layer

<details>

<summary> Читать </summary>

Кусочек сети, между Distribution и Access, имеет некоторые особенности построения,  
связанные с повышением отказоустойчивости.  
На схемах ниже L2-коммутаторы это уровень доступа, L3-коммутаторы это уровень распределения.  

**L2 access layer** может быть представлен в 2-х вариантах:

1. **Полный L2** (**STP bassed**).  
Все линки - транки. Циклы разрываются через STP.
![img_1.png](img_1.png)

После обрыва основного линка - сеть перестроится и заблокированные линки начнут работать. Придется немного подождать (см. значения таймаутов в STP). 
Из достоинств - можно использовать один и тот же VLAN (условно бухгалтерию) в разных зданиях.

2. **L2 с использованием L3-линка**.  
Разные VLAN-ы. Применяется L3 линк для разрыва цикла.
![img.png](img.png)

Нет блокирующихся линков. Более современный подход.

3. **L3 access layer**  
Можно еще более углубиться в L3 и сделать почти все в L3.  
![img_2.png](img_2.png)

Этот дизайн используется в ЦОД и крупных сетях.  
Тут начинает работать ECMP.  
STP тут не нужен, так как циклов ~~быть не может~~ не должно быть.  
Нужно маршрутизировать больше сетей, просто L2-свичами не обойдешься.  
Дороже.

</details>